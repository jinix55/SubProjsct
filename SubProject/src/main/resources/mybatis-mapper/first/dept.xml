<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.portal.adm.dept.mapper.DeptMapper">

<!-- 부서 분류 조회 -->
	<select id="selectDeptCl" parameterType="string" resultType="com.portal.adm.dept.model.DeptClModel">
WITH RECURSIVE R AS (
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , 0 AS LV
      , JSON_ARRAY(cast(M.DEPT_CODE as varchar(4000))) AS FULL_PATH_ID
      , JSON_ARRAY(cast(M.DEPT_NM as varchar(4000))) AS FULL_PATH_NM
      , cast(LPAD(M.ORD_SEQ,5,'0') as varchar(4000)) AS FULL_ORD_SEQ
      , concat(cast(LPAD(M.ORD_SEQ,5,'0') as varchar(4000)), M.DEPT_NM) AS FULL_PATH_ORD
    FROM T_DEPT_CL M
    WHERE M.UP_DEPT_CODE = 'Top' AND M.USE_YN = 'Y'
    UNION ALL
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , R.LV + 1 AS LV
      , JSON_ARRAY_APPEND(R.FULL_PATH_ID,'$',M.DEPT_CODE) AS FULL_PATH_ID
      , JSON_ARRAY_APPEND(R.FULL_PATH_NM,'$',M.DEPT_NM) AS FULL_PATH_NM
      , CONCAT(R.FULL_ORD_SEQ,LPAD(M.ORD_SEQ,5,'0')) AS FULL_ORD_SEQ
      , CONCAT(R.FULL_PATH_ORD,LPAD(M.ORD_SEQ,5,'0'),M.DEPT_NM) AS FULL_PATH_ORD
    FROM R
    JOIN T_DEPT_CL M ON R.DEPT_CODE = M.UP_DEPT_CODE AND M.USE_YN = 'Y'
) SELECT
    DEPT_CODE, UP_DEPT_CODE, DEPT_NM, ORD_SEQ, USE_YN, RGST_ID, RGST_DT, MODI_ID, MODI_DT
  , LV
  , R.FULL_PATH_ID
  , R.FULL_PATH_NM
  , R.FULL_ORD_SEQ
  , R.FULL_PATH_ORD
FROM R
WHERE DEPT_CODE = #{deptCode}
ORDER BY FULL_PATH_ORD
	</select>

<!-- 부서 분류 목록 조회 -->
	<select id="selectDeptClList" resultType="com.portal.adm.dept.model.DeptClModel">
WITH RECURSIVE R AS (
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , 0 AS LV
      , JSON_ARRAY(cast(M.DEPT_CODE as varchar(4000))) AS FULL_PATH_ID
      , JSON_ARRAY(cast(M.DEPT_NM as varchar(4000))) AS FULL_PATH_NM
      , cast(LPAD(M.ORD_SEQ,5,'0') as varchar(4000)) AS FULL_ORD_SEQ
      , concat(cast(LPAD(M.ORD_SEQ,5,'0') as varchar(4000)), M.DEPT_NM) AS FULL_PATH_ORD
    FROM T_DEPT_CL M
    WHERE M.UP_DEPT_CODE = 'Top' AND M.USE_YN = 'Y'
    UNION ALL
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , R.LV + 1 AS LV
      , JSON_ARRAY_APPEND(R.FULL_PATH_ID,'$',M.DEPT_CODE) AS FULL_PATH_ID
      , JSON_ARRAY_APPEND(R.FULL_PATH_NM,'$',M.DEPT_NM) AS FULL_PATH_NM
      , CONCAT(R.FULL_ORD_SEQ,LPAD(M.ORD_SEQ,5,'0')) AS FULL_ORD_SEQ
      , CONCAT(R.FULL_PATH_ORD,LPAD(M.ORD_SEQ,5,'0'),M.DEPT_NM) AS FULL_PATH_ORD
    FROM R
    JOIN T_DEPT_CL M ON R.DEPT_CODE = M.UP_DEPT_CODE AND M.USE_YN = 'Y'
) SELECT
    DEPT_CODE, UP_DEPT_CODE, DEPT_NM, ORD_SEQ, USE_YN, RGST_ID, RGST_DT, MODI_ID, MODI_DT
  , LV
  , R.FULL_PATH_ID
  , R.FULL_PATH_NM
  , R.FULL_ORD_SEQ
  , R.FULL_PATH_ORD
FROM R
ORDER BY FULL_PATH_ORD
	</select>

	<select id="selectDeptClSearchList" parameterType="com.portal.adm.dept.model.DeptClModel" resultType="com.portal.adm.dept.model.DeptClModel">
WITH RECURSIVE R AS (
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , 0 AS LV
      , JSON_ARRAY(cast(M.DEPT_CODE as varchar(4000))) AS FULL_PATH_ID
      , JSON_ARRAY(cast(M.DEPT_NM as varchar(4000))) AS FULL_PATH_NM
      , cast(LPAD(M.ORD_SEQ,5,'0') as varchar(4000)) AS FULL_ORD_SEQ
      , concat(cast(LPAD(M.ORD_SEQ,5,'0') as varchar(4000)), M.DEPT_NM) AS FULL_PATH_ORD
    FROM T_DEPT_CL M
    WHERE M.UP_DEPT_CODE = 'Top' AND M.USE_YN = 'Y'
    <if test="deptNm != null and deptNm != ''">
    	AND UPPER(M.DEPT_NM) LIKE CONCAT('%',UPPER(#{deptNm}),'%') 
    </if>
    <if test="deptId != null and deptId != ''">
    	AND UPPER(M.DEPT_ID) = UPPER(#{deptId})
    </if>
    UNION ALL
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , R.LV + 1 AS LV
      , JSON_ARRAY_APPEND(R.FULL_PATH_ID,'$',M.DEPT_CODE) AS FULL_PATH_ID
      , JSON_ARRAY_APPEND(R.FULL_PATH_NM,'$',M.DEPT_NM) AS FULL_PATH_NM
      , CONCAT(R.FULL_ORD_SEQ,LPAD(M.ORD_SEQ,5,'0')) AS FULL_ORD_SEQ
      , CONCAT(R.FULL_PATH_ORD,LPAD(M.ORD_SEQ,5,'0'),M.DEPT_NM) AS FULL_PATH_ORD
    FROM R
    JOIN T_DEPT_CL M ON R.DEPT_CODE = M.UP_DEPT_CODE AND M.USE_YN = 'Y'
    WHERE 1=1
    <if test="deptNm != null and deptNm != ''">
    	AND UPPER(M.DEPT_NM) LIKE CONCAT('%',UPPER(#{deptNm}),'%') 
    </if>
    <if test="deptId != null and deptId != ''">
    	AND UPPER(M.DEPT_ID) = UPPER(#{deptId})
    </if>
) SELECT
    DEPT_CODE, UP_DEPT_CODE, DEPT_NM, ORD_SEQ, USE_YN, RGST_ID, RGST_DT, MODI_ID, MODI_DT
  , LV
  , R.FULL_PATH_ID
  , R.FULL_PATH_NM
  , R.FULL_ORD_SEQ
  , R.FULL_PATH_ORD
FROM R
ORDER BY FULL_PATH_ORD
	</select>
</mapper>