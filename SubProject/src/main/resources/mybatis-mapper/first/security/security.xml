<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.portal.config.security.mapper.SecurityMapper">

    <select id="selectUser" parameterType="memberModel" resultType="memberModel">
		<![CDATA[
		select
			u.company_code,
			u.user_id,
			u.user_nm,
			u.email,
			u.phone,
			u.pstn_nm,
			u.dept_nm,
			c.company_nm,
			u.auth_code,
			cc.code_nm as auth_nm,
			u.use_yn,
			u.last_log_dt,
			u.rgst_id,
			u.rgst_dt,
			u.modi_id,
			u.modi_dt
		from
			t1_user u
			left outer join t_company c ON c.company_code = u.company_code
			left outer join t_code cc ON cc.code_id = u.auth_code and cc.group_id = 'AUTH_CD'
		where u.company_code = #{companyCode}
		  and u.user_id  =  #{userId}	
		]]>
    </select>
    
    <select id="selectUserPassCheck" parameterType="map" resultType="memberModel">
		SELECT USER_ID, PASS_INIT, PASS_ERROR from t1_user
		WHERE USER_ID = #{userId} AND COMPANY_CODE = #{companyCode} AND PASSWORD = <![CDATA[SHA2(#{password},256)]]> AND USE_YN = 'Y'
    </select>
    
    <select id="selectUserCheck" parameterType="map" resultType="memberModel">
		SELECT USER_ID, PASS_INIT, PASS_ERROR from t1_user
		WHERE USER_ID = #{userId} AND COMPANY_CODE = #{companyCode}
    </select>
    
    <update id="updateUserPassword" parameterType="memberModel">
		update t1_user SET PASSWORD = <![CDATA[SHA2(#{newPassword},256)]]>, PASS_ERROR = 0, PASS_INIT = 'N' WHERE USER_ID = #{userId} AND COMPANY_CODE = #{companyCode} AND  PASSWORD = <![CDATA[SHA2(#{password},256)]]>
    </update>
    
    <update id="updatePasswordFail" parameterType="map">
		update t1_user SET PASS_ERROR = #{passError} WHERE USER_ID = #{userId} AND COMPANY_CODE = #{companyCode}
    </update>
    
    <update id="updatePasswordInit" parameterType="map">
		update t1_user SET PASSWORD = <![CDATA[SHA2(#{newPassword},256)]]>, PASS_ERROR = 0, PASS_INIT = 'Y' WHERE COMPANY_CODE = #{companyCode} AND USER_ID = #{userId}
    </update>
    
	<update id="updateLastLogDt" parameterType="string">
		UPDATE t1_user SET LAST_LOG_DT = NOW(), PASS_ERROR = 0 WHERE COMPANY_CODE = #{companyCode} AND USER_ID = #{userId}
	</update>

	<select id="selectLoginMessage" parameterType="string" resultType="string">
		SELECT CODE_DSC FROM T_CODE WHERE GROUP_ID = 'LOGIN_MESSAGE' AND CODE_ID = #{codeId}
	</select>

    <select id="selectMenuWithAuth" resultType="menuModel" parameterType="map">
		WITH RECURSIVE R AS (
		    SELECT
		        M.MENU_ID, M.UP_MENU_ID, M.MENU_NM, M.MENU_URL, M.MENU_DSC, M.ORD_SEQ, M.MENU_SE, A.MENU_ATTR, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
		      , 0 AS LV
			  , JSON_ARRAY(cast(M.MENU_ID as varchar(4000))) AS FULL_PATH_ID
		      , JSON_ARRAY(cast(M.MENU_NM as varchar(4000))) AS FULL_PATH_NM
		      , cast(LPAD(M.ORD_SEQ,5,'0') as varchar(4000)) AS FULL_ORD_SEQ
		    FROM t_group_menu M
		    JOIN t_group_menu_auth A ON M.MENU_ID = A.MENU_ID AND M.USE_YN = 'Y' AND A.USE_YN = 'Y' AND A.AUTH_CODE = #{authCode}
		    WHERE NULLIF(M.UP_MENU_ID,'') IS NULL
		    UNION ALL
		    SELECT
		        M.MENU_ID, M.UP_MENU_ID, M.MENU_NM, M.MENU_URL, M.MENU_DSC, M.ORD_SEQ, M.MENU_SE, A.MENU_ATTR, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
		      , R.LV + 1 AS LV
		      , JSON_ARRAY_APPEND(R.FULL_PATH_ID,'$',M.MENU_ID) AS FULL_PATH_ID
		      , JSON_ARRAY_APPEND(R.FULL_PATH_NM,'$',M.MENU_NM) AS FULL_PATH_NM
		      , CONCAT(R.FULL_ORD_SEQ,'-',LPAD(M.ORD_SEQ,5,'0')) AS FULL_ORD_SEQ
		    FROM R
		    JOIN t_group_menu M ON R.MENU_ID = M.UP_MENU_ID AND M.USE_YN = 'Y'
		    JOIN t_group_menu_auth A ON M.MENU_ID = A.MENU_ID AND A.USE_YN = 'Y' AND A.AUTH_CODE = #{authCode}
		) SELECT
		    MENU_ID, UP_MENU_ID, MENU_NM, MENU_URL, MENU_DSC, ORD_SEQ, MENU_SE, MENU_ATTR, USE_YN, RGST_ID, RGST_DT, MODI_ID, MODI_DT
		  , LV
		  , R.FULL_PATH_ID
		  , R.FULL_PATH_NM
		  , R.FULL_ORD_SEQ
		FROM R
		WHERE MENU_URL = #{menuUrl}
		ORDER BY FULL_ORD_SEQ, MENU_NM LIMIT 1
    </select>

</mapper>