<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.portal.adm.product.mapper.ProductMapper">

	<sql id="searchProduct">
		<where>
			and USE_YN = 'Y'
			<if test="searchKey != '' and searchKey == 'ALL' and searchValue != ''">
				and (upper(PRODUCT_NM) like concat('%',upper(#{searchValue}),'%') or upper(PACKING_TYPE) like concat('%',upper(#{searchValue}),'%') or (upper(RECYCLE_GRADE) like concat('%',upper(#{searchValue}),'%')) or upper(COMPLETE_STATUS) like concat('%',upper(#{searchValue}),'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'productNm' and searchValue != ''">
				and (upper(PRODUCT_NM) like concat('%',upper(#{searchValue}),'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'packingType' and searchValue != ''">
				and (upper(PACKING_TYPE) like concat('%',upper(#{searchValue}),'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'recycleGrade' and searchValue != ''">
				and (upper(RECYCLE_GRADE) = upper(#{searchValue}))
			</if>
			<if test="searchKey != '' and searchKey == 'completeStatus' and searchValue != ''">
				and (upper(COMPLETE_STATUS) like concat('%',upper(#{searchValue}),'%'))
			</if>
		</where>
	</sql>
	
	<sql id="paging">
		LIMIT #{offSet}, #{pageSize}
	</sql>

	<select id="selectProductList" resultType="com.portal.adm.product.model.ProductModel" parameterType="com.portal.adm.product.model.ProductModel">
		SELECT
		    ROW_NUMBER() OVER (ORDER BY PRODUCT_ID DESC) AS ROWNUM,
			PRODUCT_ID,
			PRODUCT_NM,
			PRODUCT_CODE,
			PACKING_TYPE,
			RECYCLE_GRADE,
			COMPLETE_STATUS,
			CHECK1,
			PHOTO,
			SPEC,
			USE_YN,
			RGST_ID,
			RGST_DT,
			MODI_ID,
			MODI_DT
		FROM
			T_PRODUCT 
		<include refid="searchProduct"></include>	
        ORDER BY PRODUCT_ID DESC, ROWNUM	
        <include refid="paging"></include>		
	</select>
	
	<select id="selectProductListCount" resultType="int" parameterType="com.portal.adm.product.model.ProductModel">
		SELECT COUNT(*)
		FROM T_PRODUCT
		<include refid="searchProduct"></include>	
	</select>	

	<select id="selectProductListCountByProductCode" resultType="int" parameterType="String">
		SELECT COUNT(*)
		FROM T_PRODUCT
		WHERE upper(PRODUCT_CODE) = upper(#{productCode})
		  AND USE_YN = 'Y'		
		<include refid="searchProduct"></include>	
	</select>	

	
	<select id="selectProduct" resultType="com.portal.adm.product.model.ProductModel" parameterType="com.portal.adm.product.model.ProductModel">
		SELECT
			  a.PRODUCT_ID
			, a.PRODUCT_NM
			, a.PRODUCT_CODE
			, a.PRODUCT_CLASS
			, a.SUPPLIER_INFO
			, a.PRODUCT_MAKER
			, a.SUMMARY
			, a.PHOTO
			, a.COMPLETE_STATUS
			, a.CHECK1
			, a.MASTER_APPLY
			, a.RECEIPT_NUMBER
			, a.APPROVAL_NUMBER
			
			, a.MASTER_MAPPING
			, a.MAPPING_PRODUCT_CODE
			, b.PRODUCT_NM MAPPING_PRODUCT_NM 
			
			, a.USE_YN
			, a.RGST_ID
			, a.RGST_DT
			, a.MODI_ID
			, a.MODI_DT
		FROM
			T_PRODUCT a 
	    LEFT OUTER JOIN T_PRODUCT b
	      ON a.PRODUCT_CODE = b.MAPPING_PRODUCT_CODE
         AND b.USE_YN = 'Y'
		WHERE upper(a.PRODUCT_ID) = upper(#{productId})
		  AND a.USE_YN = 'Y'
	</select>
	
	<insert id="insertProduct" parameterType="com.portal.adm.product.model.ProductModel">
		INSERT INTO T_PRODUCT (
			  PRODUCT_ID
			, PRODUCT_NM
			, PRODUCT_CODE
			, PRODUCT_CLASS
			, SUPPLIER_INFO
			, PRODUCT_MAKER
			, SUMMARY
			, PHOTO
			, USE_YN
			, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
		) VALUES (
			  #{productId}
			, #{productNm}
			, #{productCode}
			, #{productClass}
			, #{supplierInfo}
			, #{productMaker}
			, #{summary}
			, #{photo}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)
	</insert>
	
	<update id="updateProduct" parameterType="com.portal.adm.product.model.ProductModel">
		UPDATE T_PRODUCT
		SET
			  PRODUCT_NM    = #{productNm}
			, PRODUCT_CLASS    = #{productClass}
			, SUPPLIER_INFO    = #{supplierInfo}
			, PRODUCT_MAKER    = #{productMaker}
			, SUMMARY    = #{summary}
			, PHOTO    = #{photo}
			, PACKING_TYPE  = #{packingType}
			, RECYCLE_GRADE = #{recycleGrade}
			, COMPLETE_STATUS  = #{completeStatus}
			, CHECK1   = #{check1}
			, MASTER_APPLY   = #{masterApply}
			, RECEIPT_NUMBER   = #{receiptNumber}
			, APPROVAL_NUMBER   = #{approvalNumber}
			
			, MASTER_MAPPING   = #{masterMapping}
			, MAPPING_PRODUCT_CODE   = #{mappingProductCode}
		WHERE
			PRODUCT_ID = #{productId}
	</update>
	
	<update id="deleteProduct" parameterType="com.portal.adm.product.model.ProductModel">
		UPDATE T_PRODUCT
		SET
			USE_YN = 'N'
		WHERE
			PRODUCT_ID = #{productId}
	</update>
	
	<select id="selectProductPackagingOrder" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		SELECT PRODUCT_ID, PACKAGING_ORDER, MAT_TYPE
		FROM t_product_packaging
		WHERE upper(PRODUCT_ID) = upper(#{productId})
		AND USE_YN = 'Y'
		GROUP BY PACKAGING_ORDER
	</select>	
	
	<select id="selectProductPackaging" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		SELECT
			  PACKAGING_ID
			, PRODUCT_ID
			, PRODUCT_NM
			, PACKAGING_NM
			, PACKAGING_DSC
			, PACKAGING_ORDER
			, MAT_TYPE
			, PART_TYPE
			, PART_TYPE_ORDER
			, MAT_INFO
			, WEIGHT
			, STANDARD
			, COLOR
			, ADD_EXPLAN
			, MAT_FILE_ID
			, SUPPLIER_CODE
			, MANAGER_ID
			, USE_YN
			, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
		FROM
			t_product_packaging 
		WHERE upper(PRODUCT_ID) = upper(#{productId})
		  AND USE_YN = 'Y'
		  <if test="packagingOrder  != null and packagingOrder != ''">
				and (PACKAGING_ORDER = #{packagingOrder})
		  </if>
		  <if test="packagingId  != null and packagingId != ''">
				and (PACKAGING_ID = #{packagingId})
		  </if>
	</select>
	
	<select id="selectProductPackagingDetail" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		SELECT
			  PACKAGING_ID
			, PRODUCT_ID
			, PRODUCT_NM
			, PACKAGING_NM
			, PACKAGING_DSC
			, PACKAGING_ORDER
			, MAT_TYPE
			, PART_TYPE
			, PART_TYPE_ORDER
			, MAT_INFO
			, WEIGHT
			, STANDARD
			, COLOR
			, ADD_EXPLAN
			, MAT_FILE_ID
			, SUPPLIER_CODE
			, MANAGER_ID
			, USE_YN
			, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
		FROM
			t_product_packaging 
		WHERE upper(PRODUCT_ID) = upper(#{productId})
		  AND USE_YN = 'Y'
		  AND (PACKAGING_ID = #{packagingId})
	</select>
	
	<insert id="insertProductPackaging" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		INSERT INTO t_product_packaging (
			  PACKAGING_ID   
			, PRODUCT_ID     
			, PRODUCT_NM     
			, PACKAGING_NM   
			, PACKAGING_DSC  
			, PACKAGING_ORDER
			, MAT_TYPE       
			, PART_TYPE      
			, MAT_INFO       
			, WEIGHT         
			, STANDARD       
			, COLOR          
			, ADD_EXPLAN     
			, MAT_FILE_ID    
			, SUPPLIER_CODE 
			, MANAGER_ID 
			, USE_YN         
			, RGST_ID        
			, RGST_DT        
			, MODI_ID        
			, MODI_DT        
		) VALUES (
			  #{packagingId}
			, #{productId}
			, #{productNm}
			, #{packagingNm}
			, #{packagingDsc}
			, #{packagingOrder}
			, #{matType}
			, #{partType}
			, #{matInfo}
			, #{weight}
			, #{standard}
			, #{color}
			, #{addExplan}
			, #{matFileId}
			, #{supplierCode}
			, #{managerId}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)
	</insert>
	
	<update id="updateProductPackaging" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		UPDATE t_product_packaging
		SET
			  PACKAGING_ID         = #{packagingId}      
			, PRODUCT_ID           = #{productId}        
			, PRODUCT_NM           = #{productNm}        
			, PACKAGING_NM         = #{packagingNm}      
			, PACKAGING_DSC        = #{packagingDsc}     
			, PACKAGING_ORDER      = #{packagingOrder}   
			, MAT_TYPE             = #{matType}          
			, PART_TYPE            = #{partType}         
			, MAT_INFO             = #{matInfo}          
			, WEIGHT               = #{weight}           
			, STANDARD             = #{standard}         
			, COLOR                = #{color}        
			, ADD_EXPLAN           = #{addExplan}      
			, MAT_FILE_ID          = #{matFileId}     
			, SUPPLIER_CODE        = #{supplierCode} 
			, MANAGER_ID           = #{managerId} 
			, MODI_ID              = #{modiId}           
			, MODI_DT              = now()         
		WHERE
			PACKAGING_ID = #{packagingId}
	</update>
	
	<update id="deleteProductPackaging" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		UPDATE t_product_packaging
		SET
			  USE_YN = 'N'
			, MODI_ID              = #{modiId}           
			, MODI_DT              = now()   
		WHERE
			PRODUCT_ID           = #{productId}
		  <if test="packagingOrder  != null and packagingOrder != ''">
				and (PACKAGING_ORDER = #{packagingOrder})
		  </if>
		  <if test="packagingId  != null and packagingId != ''">
				and (PACKAGING_ID = #{packagingId})
		  </if>
			
	</update>	
	
	<select id="selectProductMatType" resultType="com.portal.adm.packagingCode.model.PackagingCodeModel">
		SELECT  concat(a.code_nm,'-', b.code_nm) AS codeNm
				, b.code_id AS codeId
		  FROM  t_environ_price a, 
		        t_environ_price b
		  WHERE a.code_id = b.group_id
	</select>
	
	
	<select id="selectProductRecyleContributions" resultType="com.portal.adm.product.model.ProductModel" parameterType="com.portal.adm.product.model.ProductModel">
		SELECT
		    BASE_YEAR
			, ACCUMULATE_SALE_QTY
			, PACKING_TOTAL_WEIGHT
			, RECYLE_CONTRIBUTIONS
		FROM
			T_PRODUCT_RECYLE_CONTRIBUTIONS 
		WHERE upper(PRODUCT_ID) = upper(#{productId})
		  AND BASE_YEAR = #{inBaseYear}
		  
	</select>
	
	
	<insert id="mergeProductRecyleContributions" parameterType="com.portal.adm.product.model.ProductModel">
		INSERT INTO T_PRODUCT_RECYLE_CONTRIBUTIONS (
			  PRODUCT_ID
			, BASE_YEAR
			, ACCUMULATE_SALE_QTY
			, PACKING_TOTAL_WEIGHT
			, RECYLE_CONTRIBUTIONS
			, USE_YN
			, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
		) VALUES (
			  #{productId}
			, #{baseYear}
			, #{accumulateSaleQty}
			, #{packingTotalWeight}
			, #{recyleContributions}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)   
		ON DUPLICATE KEY UPDATE
		      ACCUMULATE_SALE_QTY   = #{accumulateSaleQty} 
		    , PACKING_TOTAL_WEIGHT  = #{packingTotalWeight} 
		    , RECYLE_CONTRIBUTIONS  = #{recyleContributions}
		    , MODI_ID               = #{modiId}           
			, MODI_DT               = now()   
		    
	</insert>
	
	<select id="selectMaxProductPackagingOrder" resultType="int" parameterType="String">
		<![CDATA[
			SELECT
			    ifnull(max(packaging_order), 0) packaging_order
			FROM
				T_PRODUCT_PACKAGING
	        WHERE use_yn = 'Y'
	         AND  product_id = #{productId}
		     AND  packaging_order <> 9
		]]>			 
	</select>

	<select id="selectMaxPartProductPackagingOrder" resultType="int" parameterType="String">
		<![CDATA[
			SELECT
			    ifnull(max(packaging_order), 0) packaging_order
			FROM
				T_PRODUCT_PACKAGING
	        WHERE use_yn = 'Y'
	         AND  product_id = #{productId}
		     AND  packaging_order >= 9
		]]>			 
	</select>	
		
		
	<select id="selectProductPackagingList" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		SELECT                                                                               
			  a.PACKAGING_ID                                          
			, a.PRODUCT_ID                                            
			, b.PRODUCT_NM                                            
			, a.PACKAGING_NM                                          
			, a.PACKAGING_DSC                                         
			, a.PACKAGING_ORDER                                       
			, a.MAT_TYPE                                              
			, a.PART_TYPE                                             
			, a.PART_TYPE_ORDER                                       
			, a.MAT_INFO                                              
			, a.WEIGHT                                                
			, a.STANDARD                                              
			, a.COLOR                                                 
			, a.ADD_EXPLAN                                       
			, a.MAT_FILE_ID        
			, a.SUPPLIER_CODE      
			, a.MANAGER_ID         
		FROM                                                       
			T_PRODUCT_PACKAGING a 
	    LEFT OUTER JOIN T_PRODUCT b
	      ON a.PRODUCT_ID = b.PRODUCT_ID
         AND b.USE_YN = 'Y'	
       WHERE a.USE_YN = 'Y'  		    		
	</select>


		
	<select id="selectProductPackagingListByProductId" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		SELECT                                                                               
			  a.PACKAGING_ID                                          
			, a.PRODUCT_ID                                            
			, a.PACKAGING_NM                                          
			, a.PACKAGING_DSC                                         
			, a.PACKAGING_ORDER                                       
			, a.MAT_TYPE                                              
			, a.PART_TYPE                                             
			, a.PART_TYPE_ORDER                                       
			, a.MAT_INFO                                              
			, a.WEIGHT                                                
			, a.STANDARD                                              
			, a.COLOR                                                 
			, a.ADD_EXPLAN                                       
			, a.MAT_FILE_ID        
			, a.SUPPLIER_CODE      
			, a.MANAGER_ID         
		FROM                                                       
			T_PRODUCT_PACKAGING a 
       WHERE a.USE_YN = 'Y'
        AND  a.PRODUCT_ID =  #{productId}
        AND  a.PACKAGING_ORDER = 1 		 		    		
	</select>








		
	<select id="getProductId" resultType="String" parameterType="String">
		SELECT                                                                               
			  PRODUCT_ID                                            
		FROM                                                       
			T_PRODUCT 
       WHERE USE_YN = 'Y' 
        AND  PRODUCT_CODE = #{productCode} 		    		
	</select>		
		
</mapper>