<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.portal.api.mapper.ApiExtrnlMapper">


    <select id="select" resultType="com.portal.api.model.ApiExtrnlModel" parameterType="com.portal.api.model.ApiExtrnlModel">
		select
			API_KEY
			, PACKAGING_ID
			, TO_COMPANY_CODE
			, TO_COMPANY_NM
			, FROM_COMPANY_CODE
			, FROM_COMPANY_NM
			, MANAGER_ID
			, MANAGER_NM
			, USE_YN
			, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
		from
		    T_API_PRODUCT_PACKAGE
		where
		    API_KEY = #{apiKey} AND USE_YN = 'Y'
    </select>

    <insert id="insert" parameterType="com.portal.api.model.ApiExtrnlModel">
		insert into T_API_PRODUCT_PACKAGE (
			API_KEY
			, PACKAGING_ID
			, TO_COMPANY_CODE
			, TO_COMPANY_NM
			, FROM_COMPANY_CODE
			, FROM_COMPANY_NM
			, MANAGER_ID
			, MANAGER_NM
			, MANAGER_MAIL
			, USE_YN
			, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
		) values (
			#{apiKey}
			, #{packagingId}
			, #{toCompanyCode}
			<!-- , #{toCompanyNm}-->
			, (SELECT SUPPLIER_NM   FROM t_supplier WHERE SUPPLIER_ID = #{toCompanyCode}) 
			, #{fromCompanyCode}
			, #{fromCompanyNm}
			, #{managerId}
			<!--  , #{managerNm} -->
			, (SELECT MANAGER_NM  FROM t_supplier_manager 
			                     WHERE SUPPLIER_ID = #{toCompanyCode} AND  MANAGER_ID = #{managerId})
			, #{managerMail}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)
    </insert>
    
    <update  id="updateDate">
    	UPDATE
			T_API_PRODUCT_PACKAGE
		SET
			USE_YN = 'N',
			MODI_ID = 'SYSTEM',
			MODI_DT = NOW()
		WHERE
			DATE_ADD(RGST_DT, INTERVAL 1 DAY) <![CDATA[<]]> NOW()
    </update>
    
    <update  id="updateUseYnN" parameterType="com.portal.adm.product.model.ProdPackagingModel">
    	UPDATE
			T_API_PRODUCT_PACKAGE
		SET
			USE_YN = 'N',
			MODI_ID = 'SYSTEM',
			MODI_DT = NOW()
		WHERE
			API_KEY = #{apiKey}
    </update>
    
    <select id="selectProdApiInfo" parameterType="com.portal.adm.product.model.ProdPackagingDetailApiModel" resultType="com.portal.adm.product.model.ProdPackagingDetailApiModel">
    	SELECT 
			  PP.PACKAGING_DETAIL_ID
 			, (SELECT PRODUCT_NM FROM t_product WHERE PRODUCT_ID = b.PRODUCT_ID) AS PRODUCT_NM
			, b.PRODUCT_CODE
			, b.PRODUCT_ID
			, b.PACKAGING_ORDER
			, b.GROUP_ID
			, PP.PART_CODE
			, PP.MAT_INFO
			, PP.WEIGHT
			, PP.STANDARD
			, PP.COLOR
			, PP.SUMMARY
			, S.SUPPLIER_CODE
			, S.SUPPLIER_ID
			, APP.TO_COMPANY_NM AS SUPPLIER_NM
			, APP.FROM_COMPANY_NM  AS UP_COMPANY__NM
			, APP.MANAGER_ID 
			, APP.MANAGER_NM 
			, APP.MANAGER_MAIL
			, S.MANAGEMENT_ID 
			, (SELECT USER_NM FROM T_USER WHERE USER_ID = S.MANAGEMENT_ID) AS MANAGEMENT_NM
			, S.REPRESENTATIVE_NM 
		FROM t_product_packaging_detail PP
		LEFT JOIN t_product_packaging b  ON PP.PACKAGING_ID = b.PACKAGING_ID
		LEFT JOIN T_API_PRODUCT_PACKAGE APP ON PP.PACKAGING_DETAIL_ID = APP.PACKAGING_ID
		LEFT JOIN T_SUPPLIER S ON APP.TO_COMPANY_CODE = S.SUPPLIER_ID
		WHERE PP.PACKAGING_DETAIL_ID = #{packagingDetailId}
		LIMIT 1
    </select>
    
   	<insert id="insertFile" parameterType="fileModel">
		INSERT INTO T_FILE (FILE_ID,STORAGE_SE,SAVE_PATH,SAVE_FILE_NM,FILE_NM,FILE_EXTSN,FILE_SIZE,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,BUCKET_NM,FILE_URL,FILE_CL,REF_ID,ATMC_DEL_YN,ATMC_DEL_DT) VALUES
		(#{fileId},#{storageSe},#{savePath},#{saveFileNm},#{fileNm},#{fileExtsn},#{fileSize},'Y',#{rgstId},NOW(),#{modiId},NOW(),#{bucketNm},#{fileUrl},#{fileCl},#{refId}
		  , CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT') THEN 'Y' ELSE 'N' END
		  , CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT')
		         THEN CURRENT_DATE + (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'PD')
		    ELSE NULL END
		)
	</insert>
	
	<update id="updatePackagingInfo">
		UPDATE t_product_packaging_detail
		SET  
<!--  		MAT_TYPE = #{matType}
		, PART_TYPE = #{partType}
		,
-->		 
		  MAT_INFO = #{matInfo}
		, WEIGHT = #{weight}
		, STANDARD = #{standard}
		, COLOR = #{color}
		, SUMMARY = #{summary}
		, MAT_FILE_ID = #{matFileId}
		, MODI_ID = #{modiId}
		, MODI_DT = NOW()
		WHERE PACKAGING_DETAIL_ID = #{packagingDetailId};
	</update>

<!--     <update id="update" parameterType="com.portal.api.model.ApiExtrnlModel"> -->
<!-- 		update t_extrnl_sys set -->
<!-- 		    extrnl_nm = #{extrnlNm} -->
<!-- 		  , extrnl_dsc = #{extrnlDsc} -->
<!-- 		  , extrnl_url = #{extrnlUrl} -->
<!-- 		  , modi_dt = now() -->
<!-- 		  , modi_id = #{modiId} -->
<!-- 		  , use_yn = 'Y' -->
<!-- 		where -->
<!-- 		    extrnl_id = #{extrnlId} -->
<!--     </update> -->

<!--     <delete id="delete" parameterType="com.portal.api.model.ApiExtrnlModel"> -->
<!-- 		update t_extrnl_sys set -->
<!-- 		    use_yn = 'N' -->
<!-- 		  , modi_dt = now() -->
<!-- 		  , modi_id = #{modiId} -->
<!-- 		where -->
<!-- 		    extrnl_id = #{extrnlId} -->
<!--     </delete> -->

	<select id="selectCompanyLogoByCompanyCode" resultType="string" parameterType="string">
		SELECT
			LOGO_FILE_ID
		FROM
			t_company
		WHERE
			COMPANY_CODE = #{companyCode}
	</select>
</mapper>