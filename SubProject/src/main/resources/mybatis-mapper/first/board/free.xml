<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.portal.adm.board.mapper.FreeMapper">
	<sql id="where">
		<where>
			<if test="searchKey != '' and searchKey == 'ALL' and searchValue != ''">
				AND (UPPER(sj) LIKE CONCAT('%',UPPER(#{searchValue}),'%') OR UPPER(cn) LIKE CONCAT('%',UPPER(#{searchValue}),'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'sj' and searchValue != ''">
				AND UPPER(sj) LIKE CONCAT('%',UPPER(#{searchValue}),'%')
			</if>
			<if test="searchKey != '' and searchKey == 'cn' and searchValue != ''">
				AND UPPER(cn) LIKE CONCAT('%',UPPER(#{searchValue}),'%')
			</if>
			<if test="searchFreeStat != null and searchFreeStat != ''">
				AND QNA_STAT = #{searchFreeStat}
			</if>			
		</where>
	</sql>
	
	<sql id="paging">
		limit #{offSet}, #{pageSize}
	</sql>

	<sql id="order">
		ORDER BY rgst_dt DESC
	</sql> 
 
	<select id="selectFreeList" resultType="com.portal.adm.board.model.FreeModel" parameterType="com.portal.common.paging.Criteria">
		SELECT
			free_id,
			cl_code,
			sj,
			cn,
			answ,
			file_id,
			answ_file_id,
			answ_rgst_id,
			answ_rgst_dt,
			bf_free_id,
			use_yn,
			rgst_id,
			rgst_dt,
			modi_id,
			modi_dt,
			free_stat,
			(SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'QNA_STAT_CODE' AND CODE_ID = free_stat) AS free_stat_nm,
			open_yn,
			(SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'OPEN_YN' AND CODE_ID = open_yn) AS open_yn_nm,
			view_cnt
		FROM 
			t_bbs_free
		<include refid="where" />
		<include refid="order" />
		<include refid="paging" />  
	</select>
	
	<select id="selectFreeListCount" resultType="int" parameterType="com.portal.common.paging.Criteria">
		SELECT
			COUNT(*)
		FROM 
			t_bbs_free
		<include refid="where" />
	</select>

	<select id="selectFree" resultType="com.portal.adm.board.model.FreeModel" parameterType="com.portal.adm.board.model.FreeModel">
		SELECT
			tbq.free_id,
			tbq.cl_code,
			(SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'QNA_CAT' AND CODE_ID = tbq.cl_code) AS free_cate_nm,
			tbq.sj,
			tbq.cn,
			tbq.answ,
			tbq.file_id,
			tbq.answ_file_id,
			tbq.answ_rgst_id,
			tbq.answ_rgst_dt,
			tbq.bf_free_id,
			tbq.use_yn,
			tbq.rgst_id,
			tbq.rgst_dt,
			tbq.modi_id,
			tbq.modi_dt,
			tbq.free_stat,
			(SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'QNA_STAT_CODE' AND CODE_ID = tbq.free_stat) AS free_stat_nm,
			tbq.open_yn,
			(SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'OPEN_YN' AND CODE_ID = tbq.open_yn) AS open_yn_nm,
			tbq.view_cnt,
			tu.user_nm as rgst_nm,
			(select dept_nm from t_dept where dept_code = tu.dept_code) as rgst_dept_nm,
			(select pstn_nm from t_pstn where pstn_code = tu.pstn_code) as rgst_pstn_nm,
			tf.file_url as rgst_photo_url			
        FROM 
            t_bbs_free tbq
            left outer join t_user tu on tbq.rgst_id = tu.user_id
            left outer join t_file tf on tu.file_url = tf.file_id
        WHERE
            tbq.free_id = #{freeId}
	</select>
	
	<update id="updateFree" parameterType="com.portal.adm.board.model.FreeModel">
		UPDATE
			t_bbs_free
		SET
			free_stat = #{freeStat},
			modi_id = #{modiId},
			modi_dt = now(),
			answ = #{answ},
			answ_rgst_id = #{answRgstId},
			answ_rgst_dt = now(),
			open_yn = #{openYn},
			use_yn = #{useYn}
	   WHERE
			free_id = #{freeId}
	</update>
	
	<update id="deleteFree" parameterType="com.portal.adm.board.model.FreeModel">
		UPDATE
			t_bbs_free
		SET
			use_yn = 'N',
			modi_id = #{modiId},
			modi_dt = now()
	   WHERE
			free_id = #{freeId}
	</update>   


</mapper>