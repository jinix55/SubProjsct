<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.portal.adm.product.mapper.ProductMapper">

	<sql id="searchProduct">
		<where>
			a.USE_YN = 'Y'
			and a.COMPANY_CODE =  #{companyCode}
			<if test="searchKey != '' and searchKey == 'productNm' and searchValue != ''">
				and (upper(a.PRODUCT_NM) like concat('%',upper(#{searchValue}),'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'packingType' and searchValue != ''">
				and (upper(a.PACKING_TYPE) like concat('%',upper(#{searchValue}),'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'recycleGrade' and searchValue != ''">
				and (upper(a.RECYCLE_GRADE) = upper(#{searchValue}))
			</if>
			<if test="searchKey != '' and searchKey == 'masterProductCode'">
				and NULLIF(a.MASTER_PRODUCT_CODE    ,'') IS NULL
			</if>
		</where>
	</sql>
	
	<sql id="paging">
		LIMIT #{offSet}, #{pageSize}
	</sql>

    <!-- 확인 2022-07-08 -->
	<select id="selectProductList" resultType="com.portal.adm.product.model.ProductModel" parameterType="com.portal.adm.product.model.ProductModel">
		SELECT
		   a.PRODUCT_ID,
		   CASE
		   	   WHEN  a.MASTER_PRODUCT_CODE IS NULL THEN a.PRODUCT_CODE
		       WHEN  a.MASTER_PRODUCT_CODE = ''    THEN a.PRODUCT_CODE         
		       ELSE  a.MASTER_PRODUCT_CODE
		    END AS SORT_CODE,
		    ROW_NUMBER() OVER (ORDER BY a.PRODUCT_NM DESC) AS ROWNUM,
			a.MASTER_PRODUCT_CODE,
			a.PRODUCT_CODE,
			a.PRODUCT_NM,
			a.PHOTO_GFILE_ID,
			(SELECT FILE_ID FROM t_group_file WHERE GFILE_ID = PHOTO_GFILE_ID AND DEL_YN = 'N' AND USE_YN = 'Y' ORDER BY RGST_DT ASC LIMIT 1) AS PHOTO_FILE_ID,
			cc.CODE_ID     AS   MAT_TYPE,
			cc.CODE_NM     AS   MAT_TYPE_NM,
			bb.CODE_NM     AS   MASTER_APPLY_NM,
			a.GRADE_CODE,
			dd.CODE_NM     AS 	SELF_EVL_GRAD_NM	
		FROM
			t_PRODUCT a 

	   LEFT OUTER JOIN t_product_packaging aa
	     ON  a.PRODUCT_ID       =  aa.PRODUCT_ID
	    AND  aa.USE_YN  = 'Y'		
	    AND  aa.PACKAGING_ORDER  = 1
			
	   LEFT OUTER JOIN t_environment_code cc
	     ON  cc.GROUP_ID     = 'GROUP_ID' 
	    AND  cc.CODE_ID      =  aa.GROUP_ID
	    AND  cc.USE_YN  = 'Y'	
		 			
	   LEFT OUTER JOIN t_code bb
	     ON  bb.GROUP_ID          = 'ENVIRONMENT_PROCEED_STAT_CODE' 
	    AND  a.MASTER_APPLY_CODE  =  bb.CODE_ID
	    AND  bb.USE_YN  = 'Y'		
	    
	   LEFT OUTER JOIN t_code dd
	     ON  dd.GROUP_ID = 'PROD_GRADE_TYPE' 
	    AND  dd.CODE_ID  =  a.GRADE_CODE
	    AND  dd.USE_YN   = 'Y'	
	   
<!-- 	   WHERE a.COMPANY_CODE =  #{companyCode} -->
<!--TODO 	-->    	
		<include refid="searchProduct"></include>	
     
      ORDER BY SORT_CODE, a.MASTER_PRODUCT_CODE, a.PRODUCT_CODE, ROWNUM DESC   
      <include refid="paging"></include>		
	</select>
	 
	
	    <!-- 확인 2022-07-08 -->
	<select id="selectProductListCount" resultType="int" parameterType="com.portal.adm.product.model.ProductModel">
		SELECT COUNT(*)
		FROM t_PRODUCT a
<!-- 		WHERE USE_YN = 'Y' -->
<!-- 		AND   COMPANY_CODE =  #{companyCode} -->
<!--TODO	 -->	
		<include refid="searchProduct"></include>
			
	</select>	

     <!-- 확인 2022-07-08 -->
	<select id="selectCountSameProductCode" resultType="int" parameterType="com.portal.adm.product.model.ProductModel">
		SELECT COUNT(*)
		FROM t_PRODUCT
		WHERE upper(PRODUCT_CODE) = upper(#{productCode})
		  AND USE_YN = 'Y'		
		  AND   COMPANY_CODE =  #{companyCode}
	</select>	

	
	<select id="selectProduct" resultType="com.portal.adm.product.model.ProductModel" parameterType="com.portal.adm.product.model.ProductModel">
		SELECT
		      a.PRODUCT_ID
			, a.PRODUCT_CODE  
			, a.MASTER_PRODUCT_CODE
			, a.PRODUCT_NM
			, a.SUPPLIER_INFO
			, a.PRODUCT_MAKER
			, a.SUMMARY
			, a.PHOTO_GFILE_ID
			, a.SPEC_GFILE_ID
			, a.MASTER_APPLY_CODE
			, a.RECEIPT_NO
			, a.APPROVAL_NO
			
<!-- 
			, a.MASTER_MAPPING_CODE
			, a.MAPPING_PRODUCT_CODE
			, b.PRODUCT_NM           MAPPING_PRODUCT_NM 
 -->			
			, c.GROUP_ID   AS  MAT_TYPE
			
			, a.RGST_ID
			, a.RGST_DT
			, a.MODI_ID
			, a.MODI_DT
		FROM
			t_PRODUCT a 
<!-- 
	    LEFT OUTER JOIN t_PRODUCT b
	      ON a.PRODUCT_ID = b.MAPPING_PRODUCT_CODE)
         AND b.USE_YN = 'Y'
        AND  b.COMPANY_CODE =  #{companyCode}
 -->     
        
	    LEFT OUTER JOIN t_product_packaging c
	      ON a.PRODUCT_ID = c.PRODUCT_ID
	     AND c.PACKAGING_ORDER = 1 
         AND c.USE_YN = 'Y'

		WHERE a.PRODUCT_ID = #{productId}
		  AND a.USE_YN = 'Y'
	</select>
	
	<insert id="insertProduct" parameterType="com.portal.adm.product.model.ProductModel">
		INSERT INTO t_PRODUCT (
		      PRODUCT_ID
		    , COMPANY_CODE
			, PRODUCT_CODE
			, MASTER_PRODUCT_CODE
			, PRODUCT_NM
			, SUPPLIER_INFO
			, SUMMARY
			, PHOTO_GFILE_ID
			, SPEC_GFILE_ID
			, USE_YN
			, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
		) VALUES (
		      #{productId}
		    , #{companyCode}
			, #{productCode}
			, #{masterProductCode}
			, #{productNm}
			, #{supplierInfo}
			, #{summary}
			, #{photoGfileId}
			, #{specGfileId}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)
	</insert>
	
	<update id="updateProduct" parameterType="com.portal.adm.product.model.ProductModel">
		UPDATE t_PRODUCT
		SET
			  PRODUCT_NM          = #{productNm}
			, MASTER_PRODUCT_CODE = #{masterProductCode}
			, SUPPLIER_INFO       = #{supplierInfo}
			, PRODUCT_MAKER       = #{productMaker}
			, SUMMARY             = #{summary}
			, PHOTO_GFILE_ID      = #{photoGfileId}
			, SPEC_GFILE_ID       = #{specGfileId}
			, MASTER_APPLY_CODE   = #{masterApplyCode}
			, RECEIPT_NO          = #{receiptNo}
			, APPROVAL_NO         = #{approvalNo}
			, MASTER_MAPPING_CODE = #{masterMappingCode}
			, MAPPING_PRODUCT_CODE   = #{mappingProductCode}
		WHERE
			PRODUCT_ID =  #{productId}
	</update>
	

	
	<update id="deleteProduct" parameterType="com.portal.adm.product.model.ProductModel">
		UPDATE t_PRODUCT
		SET
			  USE_YN = 'N'
	 		, MODI_ID  = #{modiId}
			, MODI_DT  = now()
		WHERE	PRODUCT_ID =  #{productId}
		   	
	</update>


	<select id="selectProductPackaging" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		SELECT
			  a.PACKAGING_ID
			, a.PRODUCT_ID
			, a.PRODUCT_CODE
			, b.PRODUCT_NM
			, a.PACKAGING_ORDER
			, a.GROUP_ID
			, c.CODE_NM  GROUP_NM
			, a.CODE_ID
			, d.CODE_NM  CODE_NM
		FROM
			t_product_packaging a
			 
	    LEFT OUTER JOIN t_PRODUCT b
	      ON a.PRODUCT_ID = b.PRODUCT_ID
         AND b.USE_YN = 'Y'
    
        LEFT OUTER JOIN t_environ_price c
	      ON c.GROUP_ID = 'GROUP_ID' 
	     AND c.CODE_ID = a.GROUP_ID

        LEFT OUTER JOIN t_environ_price d
	      ON d.GROUP_ID = a.GROUP_ID 
	     AND d.CODE_ID = a.CODE_ID
		WHERE a.PRODUCT_ID = #{productId}
		  AND a.USE_YN = 'Y'	 
		  <if test="packagingOrder  != null and packagingOrder != ''">
				and (a.PACKAGING_ORDER = #{packagingOrder})
		  </if>
		  <if test="packagingId  != null and packagingId != ''">
				and (a.PACKAGING_ID = #{packagingId})
		  </if>
		ORDER BY a.PACKAGING_ORDER		  
		  		  
	</select>	


	<update id="updateProductRecycleGrade" parameterType="com.portal.adm.product.model.ProductModel">
		UPDATE t_PRODUCT
		SET
			RECYCLE_GRADE = #{recycleGrade}
		WHERE
			PRODUCT_ID = #{productId}
	</update>
	
	<select id="selectProductPackagingOrder" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
 		SELECT  a.PRODUCT_CODE
		      , a.PACKAGING_ID 
		      , a.PRODUCT_ID
			  , a.PACKAGING_ORDER
			  , a.PACKAGING_ORDER_NM
			  , a.GROUP_ID
			  , b.CODE_NM  GROUP_NM
			  , a.CODE_ID
			  , c.CODE_NM  CODE_NM
			  
		FROM t_product_packaging a
		     ,  t_environ_price b
		     ,  t_environ_price c
		WHERE PRODUCT_ID = #{productId}
		AND b.GROUP_ID = 'GROUP_ID'
		AND b.CODE_ID = a.GROUP_ID
		AND c.GROUP_ID = a.GROUP_ID
		AND c.CODE_ID  = a.CODE_ID
		GROUP BY PACKAGING_ORDER
	</select>	

	<update id="deleteProductPackaging" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		UPDATE t_product_packaging
		SET
			  USE_YN = 'N'
			, MODI_ID              = #{modiId}           
			, MODI_DT              = now()   
		WHERE 1 = 1 
	      <if test="productId  != null and productId != ''">	
			    and PRODUCT_ID = #{productId}
	      </if>
<!--20220518 	      		    
		  <if test="packagingOrder  != null and packagingOrder != '' and packagingOrder != '-1'">
				and (PACKAGING_ORDER = #{packagingOrder})
		  </if>
 -->		  
		  <if test="packagingId  != null and packagingId != ''">
				and (PACKAGING_ID = #{packagingId})
		  </if>
			
	</update>	


	
	<select id="selectProductMatTypeList" resultType="com.portal.adm.environPrice.model.EnvironPriceModel">
		SELECT  a.CODE_ID   GROUP_ID
		      , a.CODE_NM   GROUP_NM
		      , b.CODE_ID   CODE_ID
		      , b.CODE_NM   CODE_NM
            , IF(a.CODE_NM = b.CODE_NM, a.CODE_NM, CONCAT('(',a.CODE_NM,'-', b.CODE_NM,')')) AS groupCodeNm		  
		  FROM  t_environ_price a, 
		        t_environ_price b
		  WHERE a.code_id = b.group_id
		ORDER BY a.ORD_SEQ, b.ORD_SEQ  
	</select>

	<insert id="insertProductPackaging" parameterType="com.portal.adm.product.model.ProdPackagingModel">
	    <![CDATA[
		INSERT INTO t_product_packaging (
			  PACKAGING_ID   
			, PRODUCT_ID  
			, PRODUCT_CODE     
			, COMPANY_CODE
			, PACKAGING_ORDER
			, PACKAGING_ORDER_NM
			, GROUP_ID       
			, CODE_ID      
			, USE_YN         
			, RGST_ID        
			, RGST_DT        
			, MODI_ID        
			, MODI_DT        
		) VALUES (
			  #{packagingId}
			, #{productId}  
			, #{productCode}
			, #{companyCode}
			, #{packagingOrder}
			, IF(#{packagingOrder}<10, CONCAT(CAST(#{packagingOrder} AS CHAR),'차포장'), '부속포장')
			, #{groupId}
			, #{codeId}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)
		]]>			
	</insert>


	<select id="selectProdPartList" resultType="com.portal.adm.product.model.ProdPartModel" parameterType="com.portal.adm.product.model.ProdPartModel">
		SELECT   aa.ENV_CODE_ID
		      ,  aa.ENV_CODE_NM
		      ,  aa.CODE_ID
		      ,  aa.CODE_NM
		 FROM  (       
		SELECT  a.CODE_ID   ENV_CODE_ID
		      ,  a.CODE_NM  ENV_CODE_NM
		      ,  b.CODE_ID
		      ,  b.CODE_NM
		      ,  b.ORD_SEQ
		  FROM  t_environment_code a
		      ,  t_code              b
		 WHERE  a.GROUP_ID = #{inGroupId}
		  AND   b.GROUP_ID = 'PROD_PART_TYPE'
		  AND   b.CODE_ID  = right(a.CODE_ID,1)
		UNION
		SELECT  ''          ENV_CODE_ID
		      ,  ''         ENV_CODE_NM
		      ,  b.CODE_ID
		      ,  b.CODE_NM
		      ,  b.ORD_SEQ      
		  FROM  t_code              b
		 WHERE  b.GROUP_ID = 'PROD_PART_TYPE'
		  AND   b.CODE_ID  = 'S'
		) aa  
		ORDER BY aa.ORD_SEQ
	</select>
	
	<select id="selectProdPackagingDetailList" resultType="com.portal.adm.product.model.ProdPackagingDetailModel" parameterType="com.portal.adm.product.model.ProdPackagingDetailModel">
	 		SELECT a.PACKAGING_DETAIL_ID
			     , a.PACKAGING_ID 
				  , a.PART_CODE
				  , b.CODE_NM    PART_NM
				  , b.ORD_SEQ
			FROM t_product_packaging_detail a
			
	      LEFT OUTER JOIN t_code b
	        ON   b.GROUP_ID   = 'PROD_PART_TYPE' 
	        AND  a.PART_CODE  =  b.CODE_ID
	        AND  b.USE_YN  = 'Y'
	        
	     WHERE  a.PACKAGING_ID = #{packagingId}
		    AND  a.USE_YN = 'Y'     
			 
	     ORDER BY b.ORD_SEQ, a.PACKAGING_DETAIL_ID		 	
	</select>	
	
	<select id="selectProdPackagingDetail" resultType="com.portal.adm.product.model.ProdPackagingDetailModel" parameterType="com.portal.adm.product.model.ProdPackagingDetailModel">
	 		SELECT a.PACKAGING_DETAIL_ID
			     , a.PACKAGING_ID 
				  , a.PART_CODE
				  , b.CODE_NM    PART_NM
				  , b.ORD_SEQ
				  , a.MAT_INFO
				  , a.WEIGHT
				  , a.STANDARD
				  , a.COLOR
				  , a.SUMMARY
				  , a.MAT_FILE_ID
				  , e.FILE_NM AS MAT_FILE_NM
				  , e.FILE_URL AS MAT_FILE_URL
				  , a.SUPPLIER_ID
				  , c.SUPPLIER_NM
				  , a.MANAGER_ID
				  , d.MANAGER_NM
				  , d.MANAGER_MAIL
			FROM t_product_packaging_detail a
			
	      LEFT OUTER JOIN t_code b
	        ON   b.GROUP_ID   = 'PROD_PART_TYPE' 
	        AND  a.PART_CODE  =  b.CODE_ID
	        AND  b.USE_YN  = 'Y'
	        
	      LEFT OUTER JOIN t_supplier c
	        ON   a.SUPPLIER_ID  = c.SUPPLIER_ID
	        AND  c.USE_YN  = 'Y'        
	        
	      LEFT OUTER JOIN t_supplier_manager d
	        ON   a.SUPPLIER_ID  = d.SUPPLIER_ID
	        AND  a.MANAGER_ID  =  d.MANAGER_ID
	        AND  d.USE_YN  = 'Y'     
	        
	      LEFT OUTER JOIN t_file e
	        ON   a.MAT_FILE_ID  = e.FILE_ID
	        AND  e.USE_YN  = 'Y'
	        AND  e.DEL_YN  = 'N'   	        
			  
	     WHERE  a.PACKAGING_DETAIL_ID = #{packagingDetailId}
		    AND  a.USE_YN = 'Y'     
 	
	</select>		
	
	<update id="delectProdPackagingDetail" parameterType="com.portal.adm.product.model.ProdPackagingDetailModel">
		UPDATE t_product_packaging_detail
		SET
			  USE_YN = 'N'
	 		, MODI_ID  = #{modiId}
			, MODI_DT  = now()
		WHERE PACKAGING_DETAIL_ID = #{packagingDetailId}
		   	
	</update>	
	
	
	<insert id="insertProdPackagingDetail" parameterType="com.portal.adm.product.model.ProdPackagingDetailModel">
		INSERT INTO t_product_packaging_detail (
			  PACKAGING_DETAIL_ID   
			, PACKAGING_ID     
			, PART_CODE
			, MAT_INFO       
			, WEIGHT      
			, STANDARD
			, COLOR
			, SUMMARY
			, MAT_FILE_ID
			, SUPPLIER_ID
			, MANAGER_ID
			, USE_YN         
			, RGST_ID        
			, RGST_DT        
			, MODI_ID        
			, MODI_DT        
		) VALUES (
			  #{packagingDetailId}
			, #{packagingId}
			, #{partCode}
			, #{matInfo}
			, #{weight}
			, #{standard}
			, #{color}
			, #{summary}
			, #{matFileId}
			, #{supplierId}
			, #{managerId}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)
	</insert>
		
		
	<update id="updateProdPackagingDetail" parameterType="com.portal.adm.product.model.ProdPackagingDetailModel">
		UPDATE t_product_packaging_detail                    
		SET                                                   
			  PACKAGING_ID  = #{packagingId}                    
			, PART_CODE     = #{partCode}                       
			, MAT_INFO      = #{matInfo}                        
			, WEIGHT        = #{weight}                         
			, STANDARD      = #{standard}                       
			, COLOR         = #{color}                          
			, SUMMARY       = #{summary}                        
			, MAT_FILE_ID   = #{matFileId}                      
			, SUPPLIER_ID   = #{supplierId}                   
			, MANAGER_ID    = #{managerId}                      
	 		, MODI_ID       = #{modiId}                         
			, MODI_DT       = now()                             
		WHERE PACKAGING_DETAIL_ID = #{packagingDetailId}			
	</update>
	
				
				
	<select id="selectProdPackagingSelfList" resultType="com.portal.adm.product.model.ProdPackagingSelfModel" parameterType="com.portal.adm.product.model.ProdPackagingSelfModel">
		SELECT  right(a.CODE_ID,1) AS PART_CODE  
		     ,  aa.CODE_NM PART_NM
		     ,  right(b.CODE_ID,1) AS GRADE_CODE 
		     ,  bb.CODE_NM GRADE_NM
		     ,  c.GROUP_ID
		     ,  c.CODE_ID
		     ,  c.CODE_NM
		     ,  cc.CODE_ID  AS CHECKED
		     ,  c.RPT_MAT_STRUCT
		     ,  c.RPT_DEV_ANAL
		     ,  c.RPT_VISUAL_JUDG
		     ,  c.RPT_TEST
		     ,  c.RPT_PERMISSION
		     ,  c.RPT_ETC		     
		  FROM  t_environment_code a
		   LEFT OUTER JOIN t_code aa
		     ON   aa.GROUP_ID   =  'PROD_PART_TYPE'
		     AND  aa.CODE_ID    =  right(a.CODE_ID,1)
		     AND  aa.USE_YN  = 'Y'
		
		     ,  t_environment_code b			       
		   LEFT OUTER JOIN t_code bb
		     ON   bb.GROUP_ID   =  'PROD_GRADE_TYPE'
		     AND  bb.CODE_ID    =  right(b.CODE_ID,1)
		     AND  bb.USE_YN  = 'Y'
		     
		     ,  t_environment_code c	
		   LEFT OUTER JOIN t_product_packaging_self cc
		     ON   cc.PACKAGING_ID  = #{packagingId}
			  AND  c.GROUP_ID   =  cc.GROUP_ID
		     AND  c.CODE_ID    =  cc.CODE_ID
		     AND  cc.USE_YN  = 'Y'   
		     
		    ,  t_product_packaging d	 
		 WHERE  d.PACKAGING_ID = #{packagingId}
		   AND  a.GROUP_ID  = d.GROUP_ID
		   AND  b.GROUP_ID  = a.CODE_ID 
		   AND  c.GROUP_ID  = b.CODE_ID 
		ORDER BY aa.ORD_SEQ, bb.ORD_SEQ, c.ORD_SEQ
 	
	</select>				
				
				
	<update id="delectProdPackagingSelf" parameterType="com.portal.adm.product.model.ProdPackagingSelfModel">
		DELETE FROM t_product_packaging_self
		WHERE PACKAGING_ID = #{packagingId}
	</update>	
	
	<insert id="insertProdPackagingSelf" parameterType="com.portal.adm.product.model.ProdPackagingSelfModel">
		INSERT INTO t_product_packaging_self (
			  PACKAGING_SELF_ID   
			, PACKAGING_ID     
			, GROUP_ID
			, CODE_ID       
			, USE_YN         
			, RGST_ID        
			, RGST_DT        
			, MODI_ID        
			, MODI_DT        
		) VALUES (
			  #{packagingSelfId}
			, #{packagingId}
			, #{groupId}
			, #{codeId}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)
	</insert>	
			
			
				
	<select id="selectProdPackagingOrderNmList" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
	    <![CDATA[
		SELECT  IFNULL(MAX(PACKAGING_ORDER) + 1 , 1) AS PACKAGING_ORDER
		     ,  CONCAT(IFNULL(MAX(PACKAGING_ORDER) + 1 , 1),'차포장') AS PACKAGING_ORDER_NM
		  FROM  t_product_packaging
		 WHERE  upper(PRODUCT_CODE) = upper(#{productCode})
		   AND  upper(COMPANY_CODE) = upper(#{companyCode})
		   AND  USE_YN = 'Y'
		   AND  PACKAGING_ORDER < 9  
		UNION    
		SELECT IFNULL(MAX(PACKAGING_ORDER) + 1 , 11)  AS PACKAGING_ORDER
		     ,  '부속포장' AS PACKAGING_ORDER_NM
		  FROM  t_product_packaging
		 WHERE   upper(PRODUCT_CODE) = upper(#{productCode})
		   AND  upper(COMPANY_CODE) = upper(#{companyCode})
		   AND  USE_YN = 'Y'
		   AND  PACKAGING_ORDER > 10  
		]]>	 	
	</select>	
	
	<select id="selectProdPackagingSelfFileList" resultType="com.portal.adm.product.model.ProdPackagingSelfFileModel" parameterType="com.portal.adm.product.model.ProdPackagingSelfFileModel">
			SELECT z.PART_CODE
			     , z.PART_NM
			     , z.MAT_REPORT_CODE
			     , z.MAT_REPORT_NM
			     
			     , z1.FILE_ID
				  , z2.FILE_NM
				  , z2.FILE_URL     
			     , z.A_ORD_SEQ
			     , z.C_ORD_SEQ
			 FROM (    
					SELECT  right(a.CODE_ID,1) AS PART_CODE  
					     ,  aa.CODE_NM PART_NM
			           ,  c.CODE_ID  MAT_REPORT_CODE   
			           ,  c.CODE_NM  MAT_REPORT_NM
			           ,  a.ORD_SEQ  A_ORD_SEQ
			           ,  c.ORD_SEQ  C_ORD_SEQ
					  FROM  t_environment_code a
			       
			 		   LEFT OUTER JOIN t_code aa
					     ON   aa.GROUP_ID   =  'PROD_PART_TYPE'
					     AND  aa.CODE_ID    =  right(a.CODE_ID,1)
					     AND  aa.USE_YN  = 'Y'
				
			 		    ,  t_product_packaging b
					    ,  t_code c 	 	 
						 
					 WHERE  b.USE_YN   =  'Y'
					   AND  b.PACKAGING_ID = #{packagingId}
					   AND  a.GROUP_ID  = b.GROUP_ID
				      AND  c.GROUP_ID   = 'MAT_REPORT_CODE' 
				      AND  c.USE_YN  = 'Y'         
				 
				 ) z
			 		   LEFT OUTER JOIN t_product_packaging_self_file z1
			   	     ON   z1.PACKAGING_ID = #{packagingId}
					     AND  z1.PART_CODE = z.PART_CODE
					     AND  z.MAT_REPORT_CODE = z1.MAT_REPORT_CODE
					     AND  z1.USE_YN  = 'Y'	 
					     
				      LEFT OUTER JOIN t_file z2
				        ON   z1.FILE_ID  = z2.FILE_ID
				        AND  z2.USE_YN  = 'Y'
				        AND  z2.DEL_YN  = 'N'   			     
					     
				ORDER BY  z.A_ORD_SEQ, z.C_ORD_SEQ     	     
 	
	</select>		
	
	<update id="deleteProdPackagingSelfFile" parameterType="com.portal.adm.product.model.ProdPackagingSelfFileModel">
	<!-- 
		UPDATE t_product_packaging_self_file
		SET
			  USE_YN = 'N'
	 		, MODI_ID  = #{modiId}
			, MODI_DT  = now()
		WHERE PACKAGING_ID = #{packagingId}
	 -->
		DELETE FROM t_product_packaging_self_file
		WHERE PACKAGING_ID = #{packagingId}
	 	   	
	</update>	
	
	<update id="deleteProdPackagingSelfFileByFileId" parameterType="com.portal.adm.product.model.ProdPackagingSelfFileModel">
		DELETE FROM t_product_packaging_self_file
		WHERE FILE_ID = #{fileId}
		   	
	</update>		
	
	<insert id="insertProdPackagingSelfFile" parameterType="com.portal.adm.product.model.ProdPackagingSelfFileModel">
		INSERT INTO t_product_packaging_self_file (
			  PACKAGING_SELF_FILE_ID   
			, PACKAGING_ID     
			, PART_CODE
			, MAT_REPORT_CODE
			, FILE_ID       
			, USE_YN         
			, RGST_ID        
			, RGST_DT        
			, MODI_ID        
			, MODI_DT        
		) VALUES (
			  #{packagingSelfFileId}
			, #{packagingId}
			, #{partCode}
			, #{matReportCode}
			, #{fileId}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)
	</insert>	

	<select id="selectProductMappingList" resultType="com.portal.adm.product.model.ProdMappingModel" parameterType="com.portal.adm.product.model.ProductModel">
		<![CDATA[
			SELECT   a.PRODUCT_CODE  MAPPING_PRODUCT_CODE, APPROVAL_NO
			   FROM  t_product a
			       , t_product_packaging b
			  WHERE  upper(a.PRODUCT_CODE) <> upper(#{productCode})
			    AND  a.USE_YN ='Y'
			    AND  b.USE_YN ='Y' 
			    AND  a.PRODUCT_CODE = b.PRODUCT_CODE
			    AND  b.PACKAGING_ORDER = 1
			    AND  a.MASTER_APPLY_CODE = 'COMPLETION'
			    AND  b.GROUP_ID  = #{matType}
 		]]>			  
	</select>	
	
	<select id="selectProductRecyle" resultType="com.portal.adm.product.model.ProductModel" parameterType="com.portal.adm.product.model.ProductModel">
		SELECT
		    BASE_YEAR
			, ACCUMULATE_SALE_QTY
			, PACKING_TOTAL_WEIGHT
			, RECYLE_CONTRIBUTIONS
		FROM
			t_product_recyle_contributions 
		WHERE COMPANY_CODE = #{companyCode}
		  AND upper(PRODUCT_CODE) = upper(#{productCode})
		  AND BASE_YEAR = #{inBaseYear}
		  
	</select>	
	
	<select id="selectProdRecycleList" resultType="com.portal.adm.product.model.ProdRecycleCalclModel" parameterType="com.portal.adm.product.model.ProdRecycleCalclModel">
		SELECT  a.PACKAGING_ORDER_NM
		     ,  sum(b.WEIGHT) WEIGHT
		     ,  c.CODE_NM GROUP_NM
		     ,  d.CODE_NM CODE_NM
		     ,  d.RECYCL_DUTY_RATE
		     ,  d.UNIT_PRICE
		     ,  d.PREMIUM
		     ,  d.DISCOUNT
		  FROM  t_product_packaging a
		     ,  t_product_packaging_detail b
		     ,  t_environ_price c
		     ,  t_environ_price d
		 WHERE  upper(PRODUCT_CODE) = upper(#{productCode})
		   AND  a.PACKAGING_ID = b.PACKAGING_ID
		   AND  c.GROUP_ID  = 'GROUP_ID'
		   AND  c.CODE_ID   =  a.GROUP_ID
		   AND  d.GROUP_ID  =  a.GROUP_ID
		   AND  d.CODE_ID   =  a.CODE_ID
		   
		GROUP BY  a.PACKAGING_ORDER_NM 
		  
	</select>		
	


	<select id="selectProductMatMappingCount" resultType="int" parameterType="com.portal.adm.product.model.ProductModel">
		<![CDATA[
		SELECT COUNT(*) FROM (
			SELECT  DISTINCT
			        a2.CODE_ID
			  FROM  t_product_packaging a1
			     ,  t_product_packaging_self a2
			 WHERE  upper(a1.PRODUCT_CODE) = upper(#{productCode})
			  AND   a1.USE_YN = 'Y'
			  AND   a1.PACKAGING_ID = a2.PACKAGING_ID    
			  AND   a2.USE_YN = 'Y'
			  AND   a2.CODE_ID NOT IN (
			SELECT  DISTINCT
			        a2.CODE_ID
			  FROM  t_product_packaging a1
			     ,  t_product_packaging_self a2
			 WHERE  upper(a1.PRODUCT_CODE) = upper(#{mappingProductCode})
			  AND   a1.USE_YN = 'Y'
			  AND   a1.PACKAGING_ID = a2.PACKAGING_ID    
			  AND   a2.USE_YN = 'Y'
			  )
			UNION   
			SELECT  DISTINCT
			        a2.CODE_ID
			  FROM  t_product_packaging a1
			     ,  t_product_packaging_self a2
			 WHERE  upper(a1.PRODUCT_CODE) = upper(#{mappingProductCode})
			  AND   a1.USE_YN = 'Y'
			  AND   a1.PACKAGING_ID = a2.PACKAGING_ID    
			  AND   a2.USE_YN = 'Y'
			  AND   a2.CODE_ID NOT IN (
			SELECT  DISTINCT
			        a2.CODE_ID
			  FROM  t_product_packaging a1
			     ,  t_product_packaging_self a2
			 WHERE  upper(a1.PRODUCT_CODE) = upper(#{productCode})
			  AND   a1.USE_YN = 'Y'
			  AND   a1.PACKAGING_ID = a2.PACKAGING_ID    
			  AND   a2.USE_YN = 'Y'
			
			) 
		) c 
		]]>			  
	</select>		
	
<!-- ************************************************************************************************** -->	
<!-- ************************************************************************************************** -->
<!-- ************************************************************************************************** -->
	
	<select id="selectProductPackagingDetailList" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		SELECT
			  a.PACKAGING_DETAIL_ID
			, a.PACKING_ID
			, a.PART_CODE
			, a.MAT_INFO
			, a.WEIGHT
			, a.STANDARD
			, a.COLOR
			, a.SUMMARY
			, a.MAT_FILE_ID
			, a.SUPPLIER_ID
			, a.MANAGER_ID
			, a.USE_YN
			, a.RGST_ID
			, a.RGST_DT
			, a.MODI_ID
			, a.MODI_DT
		FROM
			t_product_packaging a
		WHERE a.PACKAGING_ID = #{packaging}
		  AND a.USE_YN = 'Y'
	</select>
	
	


	
	

	
	<update id="updateProductPackaging" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		UPDATE t_product_packaging
		SET
			  PACKAGING_ID         = #{packagingId}      
			, PRODUCT_ID           = #{productId}        
			, PACKAGING_NM         = #{packagingNm}      
			, PACKAGING_DSC        = #{packagingDsc}     
			, PACKAGING_ORDER      = #{packagingOrder}   
			, MAT_TYPE             = #{matType}          
			, PART_TYPE            = #{partType}         
			, MAT_INFO             = #{matInfo}          
			, WEIGHT               = #{weight}           
			, STANDARD             = #{standard}         
			, COLOR                = #{color}        
			, ADD_EXPLAN           = #{addExplan}      
			, MAT_FILE_ID          = #{matFileId}     
			, SUPPLIER_ID          = #{supplierId} 
			, MANAGER_ID           = #{managerId} 
			, MODI_ID              = #{modiId}           
			, MODI_DT              = now()         
		WHERE
			PACKAGING_ID = #{packagingId}
	</update>
	


	
	

	
	
	<insert id="mergeProductRecyleContributions" parameterType="com.portal.adm.product.model.ProductModel">
		INSERT INTO T_PRODUCT_RECYLE_CONTRIBUTIONS (
			  PRODUCT_ID
			, BASE_YEAR
			, ACCUMULATE_SALE_QTY
			, PACKING_TOTAL_WEIGHT
			, RECYLE_CONTRIBUTIONS
			, USE_YN
			, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
		) VALUES (
			  #{productId}
			, #{baseYear}
			, #{accumulateSaleQty}
			, #{packingTotalWeight}
			, #{recyleContributions}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)   
		ON DUPLICATE KEY UPDATE
		      ACCUMULATE_SALE_QTY   = #{accumulateSaleQty} 
		    , PACKING_TOTAL_WEIGHT  = #{packingTotalWeight} 
		    , RECYLE_CONTRIBUTIONS  = #{recyleContributions}
		    , MODI_ID               = #{modiId}           
			, MODI_DT               = now()   
		    
	</insert>
	
	<select id="selectMaxProductPackagingOrder" resultType="int" parameterType="String">
		<![CDATA[
			SELECT
			    ifnull(max(packaging_order), 0) packaging_order
			FROM
				T_PRODUCT_PACKAGING
	        WHERE use_yn = 'Y'
	         AND  product_id = #{productId}
		     AND  packaging_order < 9
		]]>			 
	</select>

	<select id="selectMaxPartProductPackagingOrder" resultType="int" parameterType="String">
		<![CDATA[
			SELECT
			    ifnull(max(packaging_order), 8) packaging_order
			FROM
				T_PRODUCT_PACKAGING
	        WHERE use_yn = 'Y'
	         AND  product_id = #{productId}
		     AND  packaging_order >= 9
		]]>			 
	</select>	
		
		
	<select id="selectProductPackagingList" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		SELECT                                                                               
			  a.PACKAGING_ID                                          
			, a.PRODUCT_ID                                            
			, b.PRODUCT_NM                                            
			, a.PACKAGING_NM                                          
			, a.PACKAGING_DSC                                         
			, a.PACKAGING_ORDER                                       
			, a.MAT_TYPE                                              
			, a.PART_TYPE                                             
			, a.PART_TYPE_ORDER                                       
			, a.MAT_INFO                                              
			, a.WEIGHT                                                
			, a.STANDARD                                              
			, a.COLOR                                                 
			, a.ADD_EXPLAN                                       
			, a.MAT_FILE_ID        
			, a.SUPPLIER_ID     
			, a.MANAGER_ID         
		FROM                                                       
			T_PRODUCT_PACKAGING a 
	    LEFT OUTER JOIN T_PRODUCT b
	      ON a.PRODUCT_ID = b.PRODUCT_ID
         AND b.USE_YN = 'Y'	
       WHERE a.USE_YN = 'Y'  		    		
	</select>


		
	<select id="selectProductPackagingListByProductId" resultType="com.portal.adm.product.model.ProdPackagingModel" parameterType="com.portal.adm.product.model.ProdPackagingModel">
		SELECT                                                                               
			  a.PACKAGING_ID                                          
			, a.PRODUCT_ID                                            
			, a.PACKAGING_NM                                          
			, a.PACKAGING_DSC                                         
			, a.PACKAGING_ORDER                                       
			, a.MAT_TYPE                                              
			, a.PART_TYPE                                             
			, a.PART_TYPE_ORDER                                       
			, a.MAT_INFO                                              
			, a.WEIGHT                                                
			, a.STANDARD                                              
			, a.COLOR                                                 
			, a.ADD_EXPLAN                                       
			, a.MAT_FILE_ID        
			, a.SUPPLIER_ID      
			, a.MANAGER_ID         
		FROM                                                       
			T_PRODUCT_PACKAGING a 
       WHERE a.USE_YN = 'Y'
        AND  a.PRODUCT_ID =  #{productId}
        AND  a.PACKAGING_ORDER = 1 		 		    		
	</select>



		
	<select id="getProductId" resultType="String" parameterType="String">
		SELECT                                                                               
			  PRODUCT_ID                                            
		FROM                                                       
			T_PRODUCT 
       WHERE USE_YN = 'Y' 
        AND  PRODUCT_CODE = #{productCode} 		    		
	</select>
	
	<select id="getProductNm" resultType="String" parameterType="String">
		SELECT                                                                               
			  PRODUCT_NM                                            
		FROM                                                       
			T_PRODUCT 
       WHERE USE_YN = 'Y' 
        AND  upper(PRODUCT_CODE) = upper(#{productCode}) 		    		
	</select>
	
	
	<select id="selectProductSelfPackaging" resultType="com.portal.adm.product.model.ProdPackagingMatModel" parameterType="com.portal.adm.product.model.ProdPackagingMatModel">
		SELECT
			  PACKAGING_MAT_ID
			, PACKAGING_ID   
			, PRODUCT_ID     
			, PACKAGING_ORDER
			, FILE
<!-- 			, MAT_TYPE        -->
<!-- 			, PART_TYPE       -->
			, GROUP_ID       
			, CODE_ID         
			, USE_YN         
			, RGST_ID        
			, RGST_DT        
			, MODI_ID        
			, MODI_DT        
		FROM t_product_packaging_mat
		WHERE PRODUCT_ID = #{productId} 
		  AND PACKAGING_ORDER = #{packagingOrder} 
		  AND USE_YN = 'Y'
	</select>	
	
	<insert id="insertProductSelfPackaging" parameterType="com.portal.adm.product.model.ProdPackagingMatModel">
		INSERT INTO t_product_packaging_mat (
			  PACKAGING_MAT_ID
			, PACKAGING_ID   
			, PRODUCT_ID     
			, PACKAGING_ORDER
			, FILE
<!-- 			, MAT_TYPE        -->
<!-- 			, PART_TYPE       -->
			, GROUP_ID       
			, CODE_ID         
			, USE_YN         
			, RGST_ID        
			, RGST_DT        
			, MODI_ID        
			, MODI_DT        
		) VALUES (
			  #{packagingMatId}
			, #{packagingId}
			, #{productId}
			, #{packagingOrder}
			, #{file}
<!-- 			, #{matType} -->
<!-- 			, #{partType} -->
			, #{groupId}
			, #{codeId}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)
	</insert>		
		
	<delete id="deleteProductSelfPackaging" parameterType="com.portal.adm.product.model.ProdPackagingMatModel">
<!--  		UPDATE t_product_packaging_mat
		SET
			  USE_YN = 'N'
			, MODI_ID              = #{modiId}           
			, MODI_DT              = now()   
		WHERE
			PRODUCT_ID           = #{productId}
			and (PACKAGING_ORDER = #{packagingOrder})
-->
      DELETE FROM 	t_product_packaging_mat
      		WHERE
			PRODUCT_ID           = #{productId}
			and PACKAGING_ORDER = #{packagingOrder}
      		
	</delete>	
</mapper>