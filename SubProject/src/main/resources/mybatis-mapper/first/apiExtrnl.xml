<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.portal.api.mapper.ApiExtrnlMapper">


    <select id="select" resultType="com.portal.api.model.ApiExtrnlModel" parameterType="com.portal.api.model.ApiExtrnlModel">
		select
			API_KEY
			, PACKAGING_ID
			, TO_COMPANY_CODE
			, TO_COMPANY_NM
			, FROM_COMPANY_CODE
			, FROM_COMPANY_NM
			, MANAGER_ID
			, MANAGER_NM
			, USE_YN
			, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
		from
		    T_API_PRODUCT_PACKAGE
		where
		    API_KEY = #{apiKey} AND USE_YN = 'Y'
    </select>

    <insert id="insert" parameterType="com.portal.api.model.ApiExtrnlModel">
		insert into T_API_PRODUCT_PACKAGE (
			API_KEY
			, PACKAGING_ID
			, TO_COMPANY_CODE
			, TO_COMPANY_NM
			, FROM_COMPANY_CODE
			, FROM_COMPANY_NM
			, MANAGER_ID
			, MANAGER_NM
			, MANAGER_MAIL
			, USE_YN
			, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
		) values (
			#{apiKey}
			, #{packagingId}
			, #{toCompanyCode}
			, #{toCompanyNm}
			, #{fromCompanyCode}
			, #{fromCompanyNm}
			, #{managerId}
			, #{managerNm}
			, #{managerMail}
			, 'Y'
			, #{rgstId}
			, now()
			, #{modiId}
			, now()
		)
    </insert>
    
    <update  id="updateDate">
    	UPDATE
			T_API_PRODUCT_PACKAGE
		SET
			USE_YN = 'N',
			MODI_ID = 'SYSTEM',
			MODI_DT = NOW()
		WHERE
			DATE_ADD(RGST_DT, INTERVAL 1 DAY) <![CDATA[<]]> NOW()
    </update>
    
    <select id="selectProdApiInfo" parameterType="com.portal.adm.product.model.ProdPackagingModel" resultType="com.portal.adm.product.model.ProdPackagingModel">
    	SELECT 
			PP.PACKAGING_ID
			, PP.PRODUCT_NM
			, PP.PRODUCT_ID
			, PP.PACKAGING_ORDER
			, PP.MAT_TYPE
			, PP.PART_TYPE
			, PP.MAT_INFO
			, PP.WEIGHT
			, PP.STANDARD
			, PP.COLOR
			, PP.ADD_EXPLAN
			, S.SUPPLIER_CODE
			, APP.TO_COMPANY_NM AS SUPPLIER_NM
			, APP.FROM_COMPANY_NM  AS UP_COMPANY__NM
			, APP.MANAGER_ID 
			, APP.MANAGER_NM 
			, APP.MANAGER_MAIL
			, S.MANAGEMENT_ID 
			, (SELECT USER_NM FROM T_USER WHERE USER_ID = S.MANAGEMENT_ID) AS MANAGEMENT_NM
			, S.REPRESENTATIVE_NM 
		FROM T_PRODUCT_PACKAGING PP
		LEFT JOIN T_API_PRODUCT_PACKAGE APP ON PP.PACKAGING_ID = APP.PACKAGING_ID
		LEFT JOIN T_SUPPLIER S ON APP.TO_COMPANY_CODE = S.SUPPLIER_CODE
		WHERE PP.PACKAGING_ID = #{packagingId}
    </select>
    
   	<insert id="insertFile" parameterType="fileModel">
		INSERT INTO T_FILE (FILE_ID,STORAGE_SE,SAVE_PATH,SAVE_FILE_NM,FILE_NM,FILE_EXTSN,FILE_SIZE,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,BUCKET_NM,FILE_URL,FILE_CL,REF_ID,ATMC_DEL_YN,ATMC_DEL_DT) VALUES
		(#{fileId},#{storageSe},#{savePath},#{saveFileNm},#{fileNm},#{fileExtsn},#{fileSize},'Y',#{rgstId},NOW(),#{modiId},NOW(),#{bucketNm},#{fileUrl},#{fileCl},#{refId}
		  , CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT') THEN 'Y' ELSE 'N' END
		  , CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT')
		         THEN CURRENT_DATE + (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'PD')
		    ELSE NULL END
		)
	</insert>
	
	<update id="updatePackagingInfo">
		UPDATE T_PRODUCT_PACKAGING
		SET  MAT_TYPE = #{matType}
		, PART_TYPE = #{partType}
		, MAT_INFO = #{matInfo}
		, WEIGHT = #{weight}
		, STANDARD = #{standard}
		, COLOR = #{color}
		, ADD_EXPLAN = #{addExplan}
		, MAT_FILE_ID = #{matFileId}
		, MODI_ID = #{modiId}
		, MODI_DT = NOW()
		WHERE PACKAGING_ID = #{packagingId};
	</update>

<!--     <update id="update" parameterType="com.portal.api.model.ApiExtrnlModel"> -->
<!-- 		update t_extrnl_sys set -->
<!-- 		    extrnl_nm = #{extrnlNm} -->
<!-- 		  , extrnl_dsc = #{extrnlDsc} -->
<!-- 		  , extrnl_url = #{extrnlUrl} -->
<!-- 		  , modi_dt = now() -->
<!-- 		  , modi_id = #{modiId} -->
<!-- 		  , use_yn = 'Y' -->
<!-- 		where -->
<!-- 		    extrnl_id = #{extrnlId} -->
<!--     </update> -->

<!--     <delete id="delete" parameterType="com.portal.api.model.ApiExtrnlModel"> -->
<!-- 		update t_extrnl_sys set -->
<!-- 		    use_yn = 'N' -->
<!-- 		  , modi_dt = now() -->
<!-- 		  , modi_id = #{modiId} -->
<!-- 		where -->
<!-- 		    extrnl_id = #{extrnlId} -->
<!--     </delete> -->

</mapper>